<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MacAtlas v2.2</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #888;
            --window-bg: #ffffff;
            --border-color: #000000;
        }

        body {
            font-family: 'VT323', monospace;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; 
            height: 100dvh;
            overflow: hidden; 
            box-sizing: border-box;
            background-image: 
                linear-gradient(45deg, #aaa 25%, transparent 25%), 
                linear-gradient(-45deg, #aaa 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #aaa 75%), 
                linear-gradient(-45deg, transparent 75%, #aaa 75%);
            background-size: 2px 2px;
        }

        /* RETRO MAC WINDOW */
        #main-window {
            width: 95%;
            max-width: 900px;
            height: 90vh;
            background: var(--window-bg);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #title-bar {
            background: repeating-linear-gradient(
                to bottom,
                #000,
                #000 1px,
                #fff 1px,
                #fff 2px
            );
            height: 24px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: default;
        }

        #title-text {
            background: #fff;
            padding: 0 10px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
        }

        #close-btn {
            position: absolute;
            left: 6px;
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            background: #fff;
            box-shadow: 1px 1px 0 #000;
        }

        /* CONTENT AREA */
        #content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* SCREEN MANAGEMENT */
        .screen {
            display: none; /* Default hidden */
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
        }

        .screen.active {
            display: flex; /* Only show when active class is present */
        }

        h1 {
            font-size: 48px;
            margin: 20px 0;
            text-align: center;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0 #ccc;
        }

        .btn {
            background: #fff;
            border: 2px solid #000;
            padding: 10px 30px;
            margin: 10px;
            font-family: 'VT323', monospace;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 3px 3px 0 #000;
            transition: transform 0.1s, box-shadow 0.1s;
            min-width: 200px;
            text-align: center;
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #000;
        }

        .btn:hover {
            background: #eee;
        }

        /* GAME HUD */
        #hud {
            width: 100%;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
            font-size: 24px;
        }

        /* MAP GAME */
        #map-container {
            flex: 1;
            width: 100%;
            position: relative;
            background: #f0f8ff;
            border: 2px solid #000;
            overflow: hidden;
            touch-action: none;
        }
        
        svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        path {
            fill: #fff;
            stroke: #000;
            stroke-width: 1;
            cursor: pointer;
            transition: fill 0.2s;
        }

        path:hover {
            fill: #ddd;
        }

        path.correct {
            fill: #444 !important;
            color: white;
        }
        
        path.highlighted {
            animation: blink 1s infinite;
            fill: #888 !important;
        }

        path.wrong {
            fill: #000 !important;
        }

        @keyframes blink {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* FEEDBACK BAR */
        #feedback-bar {
            margin-top: 10px;
            width: 100%;
            height: 40px;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: #eee;
            transition: background 0.2s;
        }

        #feedback-bar.correct {
            background: #000;
            color: #fff;
        }

        #feedback-bar.wrong {
            background: repeating-linear-gradient(
                45deg,
                #fff,
                #fff 10px,
                #ccc 10px,
                #ccc 20px
            );
            color: #000;
            font-weight: bold;
        }

        /* CAPITALS GAME UI */
        #capitals-area {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent spillover */
        }

        #capital-prompt {
            font-size: 28px;
            margin-bottom: 10px;
            text-align: center;
        }

        #capital-state-preview {
            height: 200px;
            width: 100%;
            max-width: 300px;
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Specific styling for the preview SVG to differentiate from main map */
        #capital-state-preview svg {
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.2));
        }
        
        #capital-state-preview path {
            fill: #ddd; /* Light grey fill for the single state */
            stroke: #000;
            stroke-width: 2; /* Thicker border */
            cursor: default;
        }

        #capital-state-name {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            text-decoration: underline;
            text-align: center;
        }

        #options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .option-btn {
            background: #fff;
            border: 2px solid #000;
            padding: 12px;
            font-family: 'VT323', monospace;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.1s;
            text-align: center;
        }

        .option-btn:hover {
            background: #eee;
        }

        .option-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }

        .option-btn.correct-anim {
            background: #000;
            color: #fff;
        }

        .option-btn.wrong-anim {
            opacity: 0.5;
            background: #aaa;
            text-decoration: line-through;
        }

        /* REPORT CARD MODAL */
        #report-modal {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #report-card {
            background: #fff;
            border: 4px double #000;
            padding: 40px;
            text-align: center;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.2);
        }

        .shake-effect {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* LOADING */
        #loading-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
    </style>
</head>
<body>

    <div id="main-window">
        <div id="title-bar">
            <div id="close-btn" onclick="quitGame()"></div>
            <div id="title-text">MacAtlas v2.2</div>
        </div>

        <div id="content">
            
            <!-- LOADING SCREEN -->
            <div id="loading-screen" class="screen active">
                <p>LOADING GEOGRAPHY DATA...</p>
                <p id="loading-status">0%</p>
            </div>

            <!-- MENU SCREEN -->
            <div id="menu-screen" class="screen">
                <h1>MacAtlas</h1>
                <p style="text-align:center; font-size: 20px;">USA EDITION</p>
                <div style="height: 20px;"></div>
                <button class="btn" onclick="startGame('map')">FIND THE STATE</button>
                <button class="btn" onclick="startGame('capitals')">NAME THE CAPITAL</button>
            </div>

            <!-- GAME SCREEN -->
            <div id="game-screen" class="screen">
                <div id="hud">
                    <span id="score-display">SCORE: 000</span>
                    <span id="timer-display">TIME: 00:00</span>
                    <button style="font-family:'VT323'; background:none; border:1px solid #000; cursor:pointer;" onclick="quitGame()">QUIT</button>
                </div>

                <!-- MAP MODE ELEMENTS -->
                <div id="map-game-ui" style="display:none; width: 100%; height: 100%; flex-direction: column;">
                    <div id="map-container">
                        <!-- SVG injected here -->
                    </div>
                    <div id="feedback-bar">Locating Data...</div>
                </div>

                <!-- CAPITALS MODE ELEMENTS -->
                <div id="capitals-game-ui" style="display:none; width: 100%; height: 100%; flex-direction: column; align-items: center;">
                    <div id="capitals-area">
                        <div id="capital-prompt">WHAT IS THE CAPITAL OF</div>
                        <!-- New Container for State Outline -->
                        <div id="capital-state-preview"></div>
                        <div id="capital-state-name">CALIFORNIA</div>
                        
                        <div id="options-grid">
                            <button class="option-btn" id="opt-0" onclick="checkCapital(0)">SACRAMENTO</button>
                            <button class="option-btn" id="opt-1" onclick="checkCapital(1)">AUSTIN</button>
                            <button class="option-btn" id="opt-2" onclick="checkCapital(2)">BOSTON</button>
                            <button class="option-btn" id="opt-3" onclick="checkCapital(3)">ALBANY</button>
                        </div>
                    </div>
                    <!-- Empty initially, text removed as requested -->
                    <div id="feedback-bar" style="margin-top:auto;"></div>
                </div>
            </div>

            <!-- REPORT MODAL -->
            <div id="report-modal">
                <div id="report-card">
                    <h2>REPORT CARD</h2>
                    <h1 id="report-percent" style="font-size:80px; margin: 10px 0;">100%</h1>
                    <p id="report-fraction">10 / 10 Correct</p>
                    <button class="btn" onclick="closeReport()">OK</button>
                </div>
            </div>

        </div>
    </div>

<script>
    // --- GLOBAL STATE ---
    const state = {
        allData: [],
        gameMode: null, // 'map' or 'capitals'
        score: 0,
        startTime: 0,
        timerInterval: null,
        pool: [], // Shuffled list of states for the current round
        currentIdx: 0,
        
        // Stats for report
        testTotal: 0,
        testCorrect: 0,

        // Capitals specific
        currentOptions: [] // Stores the 4 current capital objects
    };

    const SVG_WIDTH = 959;
    const SVG_HEIGHT = 593;

    // --- HELPER TO SWITCH SCREENS CLEANLY ---
    function showScreen(screenId) {
        // Hide all screens first to prevent sticking
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        // Show target
        document.getElementById(screenId).classList.add('active');
    }

    // --- INITIALIZATION ---
    async function fetchStateData() {
        try {
            const response = await fetch('state_data.json');
            if (!response.ok) throw new Error("Could not load state_data.json");
            
            const data = await response.json();
            
            if(!Array.isArray(data)) throw new Error("JSON is not an array");
            
            state.allData = data;
            
            // Initial render of SVG (hidden) to prep
            renderMap();
            
            // Transition to menu
            showScreen('menu-screen');
            
        } catch (e) {
            document.getElementById('loading-status').innerText = "ERROR LOADING DATA: " + e.message;
            console.error(e);
        }
    }

    function renderMap() {
        const ns = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(ns, "svg");
        svg.setAttribute("viewBox", `0 0 ${SVG_WIDTH} ${SVG_HEIGHT}`);
        svg.setAttribute("preserveAspectRatio", "xMidYMid meet");

        state.allData.forEach(s => {
            const path = document.createElementNS(ns, "path");
            path.setAttribute("d", s.path);
            path.setAttribute("id", "map-" + s.name.replace(/\s/g, '')); 
            path.setAttribute("data-name", s.name);
            
            path.addEventListener('click', (e) => {
                if (state.gameMode === 'map') handleMapClick(s);
            });

            svg.appendChild(path);
        });

        const container = document.getElementById('map-container');
        container.innerHTML = '';
        container.appendChild(svg);
    }

    // --- GAME LOOP ---

    function startGame(mode) {
        state.gameMode = mode;
        state.score = 0;
        state.testTotal = 0;
        state.testCorrect = 0;
        state.startTime = Date.now();
        
        state.pool = [...state.allData].sort(() => 0.5 - Math.random());
        state.pool = state.pool.slice(0, 10);
        state.currentIdx = 0;

        document.getElementById('score-display').innerText = "SCORE: 0";
        showScreen('game-screen');

        if (state.timerInterval) clearInterval(state.timerInterval);
        state.timerInterval = setInterval(updateTimer, 1000);

        if (mode === 'map') {
            document.getElementById('map-game-ui').style.display = 'flex';
            document.getElementById('capitals-game-ui').style.display = 'none';
            loadMapRound();
        } else {
            document.getElementById('map-game-ui').style.display = 'none';
            document.getElementById('capitals-game-ui').style.display = 'flex';
            loadCapitalRound();
        }
    }

    function quitGame() {
        if (state.timerInterval) clearInterval(state.timerInterval);
        document.getElementById('report-modal').style.display = 'none';
        showScreen('menu-screen');
        
        // Reset Map colors
        document.querySelectorAll('path').forEach(p => {
            p.classList.remove('correct', 'wrong', 'highlighted');
            p.style.fill = '';
        });
    }

    function updateTimer() {
        const delta = Math.floor((Date.now() - state.startTime) / 1000);
        const m = Math.floor(delta / 60).toString().padStart(2, '0');
        const s = (delta % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `TIME: ${m}:${s}`;
    }

    // --- CAPITALS GAME LOGIC ---

    function loadCapitalRound() {
        if (state.currentIdx >= state.pool.length) {
            showReport();
            return;
        }

        const targetState = state.pool[state.currentIdx];
        
        // Update Text
        document.getElementById('capital-state-name').innerText = targetState.name.toUpperCase();
        const feedback = document.getElementById('feedback-bar');
        feedback.className = '';
        feedback.innerText = ""; // Empty string as requested, "Select Option" removed

        // --- RENDER STATE OUTLINE ---
        const previewContainer = document.getElementById('capital-state-preview');
        previewContainer.innerHTML = ''; // Clear previous

        const ns = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(ns, "svg");
        // Initial viewbox 0 0 100 100 (temp)
        svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
        
        const path = document.createElementNS(ns, "path");
        path.setAttribute("d", targetState.path);
        svg.appendChild(path);
        previewContainer.appendChild(svg);

        // Auto-Zoom Logic:
        // We need to wait for the browser to calculate the path dimensions (BBox)
        // then set the SVG viewBox to match those dimensions so it "zooms in"
        setTimeout(() => {
            try {
                const bbox = path.getBBox();
                // Add some padding
                const pad = 30; 
                // viewBox: min-x min-y width height
                svg.setAttribute("viewBox", `${bbox.x - pad} ${bbox.y - pad} ${bbox.width + (pad*2)} ${bbox.height + (pad*2)}`);
            } catch(e) {
                // Fallback if BBox fails (rare)
                console.error("Auto-zoom failed", e);
            }
        }, 10);

        // --- OPTIONS GENERATION ---
        const correctOption = { name: targetState.capital, isCorrect: true };
        const distractorsPool = state.allData.filter(s => s.name !== targetState.name);
        const shuffledDistractors = distractorsPool.sort(() => 0.5 - Math.random()).slice(0, 3);
        
        const options = shuffledDistractors.map(s => ({ name: s.capital, isCorrect: false }));
        options.push(correctOption);

        state.currentOptions = options.sort(() => 0.5 - Math.random());

        for(let i=0; i<4; i++) {
            const btn = document.getElementById(`opt-${i}`);
            btn.innerText = state.currentOptions[i].name.toUpperCase();
            btn.classList.remove('correct-anim', 'wrong-anim');
            btn.disabled = false;
        }
    }

    function checkCapital(idx) {
        const selected = state.currentOptions[idx];
        const btn = document.getElementById(`opt-${idx}`);
        const feedback = document.getElementById('feedback-bar');

        for(let i=0; i<4; i++) document.getElementById(`opt-${i}`).disabled = true;

        state.testTotal++;

        if (selected.isCorrect) {
            state.testCorrect++;
            state.score += 10;
            document.getElementById('score-display').innerText = "SCORE: " + state.score;
            
            btn.classList.add('correct-anim');
            feedback.className = 'correct';
            feedback.innerText = "CORRECT!";
            
            setTimeout(nextCapitalRound, 1000);
        } else {
            btn.classList.add('wrong-anim');
            feedback.className = 'wrong';
            feedback.innerText = `WRONG. ANSWER WAS ${getCorrectCapitalName().toUpperCase()}`;
            
            state.currentOptions.forEach((opt, i) => {
                if(opt.isCorrect) document.getElementById(`opt-${i}`).classList.add('correct-anim');
            });

            const win = document.getElementById('game-screen');
            void win.offsetWidth; win.classList.add('shake-effect');

            setTimeout(nextCapitalRound, 2000);
        }
    }

    function getCorrectCapitalName() {
        const correct = state.currentOptions.find(o => o.isCorrect);
        return correct ? correct.name : "";
    }

    function nextCapitalRound() {
        const win = document.getElementById('game-screen');
        win.classList.remove('shake-effect');
        state.currentIdx++;
        loadCapitalRound();
    }


    // --- MAP GAME LOGIC ---
    
    function loadMapRound() {
        document.querySelectorAll('path').forEach(p => {
            p.classList.remove('highlighted', 'wrong', 'correct');
        });

        if (state.currentIdx >= state.pool.length) {
            showReport();
            return;
        }

        const target = state.pool[state.currentIdx];
        const feedback = document.getElementById('feedback-bar');
        feedback.className = '';
        feedback.innerText = `FIND: ${target.name.toUpperCase()}`;
    }

    function handleMapClick(clickedState) {
        const correct = state.pool[state.currentIdx];
        const feedback = document.getElementById('feedback-bar');
        const win = document.getElementById('game-screen');

        if (state.currentIdx >= state.pool.length) return;

        const clickedEl = document.getElementById("map-" + clickedState.name.replace(/\s/g, ''));
        
        state.testTotal++;

        if (clickedState.name === correct.name) {
            clickedEl.classList.add('correct');
            feedback.className = 'correct';
            feedback.innerText = "GOOD JOB!";
            state.testCorrect++;
            state.score += 15;
            document.getElementById('score-display').innerText = "SCORE: " + state.score;
            setTimeout(nextMapRound, 1000);
        } else {
            void win.offsetWidth; win.classList.add('shake-effect');
            clickedEl.classList.add('wrong');
            
            const correctEl = document.getElementById("map-" + correct.name.replace(/\s/g, ''));
            correctEl.classList.add('highlighted'); 

            feedback.classList.add('wrong');
            feedback.innerText = `THAT IS ${clickedState.name.toUpperCase()}. FIND ${correct.name.toUpperCase()}.`;
            setTimeout(nextMapRound, 2000);
        }
    }

    function nextMapRound() {
        const win = document.getElementById('game-screen');
        win.classList.remove('shake-effect');
        state.currentIdx++;
        loadMapRound();
    }

    // --- REPORT CARD ---
    function showReport() {
        const pct = state.testTotal === 0 ? 0 : Math.round((state.testCorrect / state.testTotal) * 100);
        document.getElementById('report-percent').innerText = pct + "%";
        document.getElementById('report-fraction').innerText = `${state.testCorrect} / ${state.testTotal} Correct`;
        document.getElementById('report-modal').style.display = 'flex';
    }

    function closeReport() {
        document.getElementById('report-modal').style.display = 'none';
        quitGame();
    }

    // Start loading
    fetchStateData(); 

</script>
</body>
</html>
